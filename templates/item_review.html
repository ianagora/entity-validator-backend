{% extends "base.html" %}
{% block title %}Manual Review – Scrutinise{% endblock %}
{% block page_title %}Manual Review{% endblock %}

{% block content %}
<style>
  /* Scoped styles so we don't leak into other pages */
  .grid-2 { display: grid; grid-template-columns: 1fr 1.6fr; gap: 1.25rem; }
  @media (max-width: 980px) { .grid-2 { grid-template-columns: 1fr; } }

  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px 18px; box-shadow:0 4px 14px rgba(2,6,23,.04); }
  .card h3 { margin:0 0 8px 0; font-size:1rem; font-weight:700; color:#0f172a; }
  .muted { color:#64748b; }
  .kvs { width:100%; border-collapse:collapse; font-size:.95rem; }
  .kvs tr td:first-child { width:220px; padding:8px 10px; color:#0f172a; font-weight:600; }
  .kvs tr td:last-child { padding:8px 10px; color:#111827; }
  .badge { display:inline-block; border-radius:999px; padding:2px 10px; font-size:.8rem; font-weight:700; }
  .badge.green { background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; }
  .badge.amber { background:#fffbeb; color:#92400e; border:1px solid #fcd34d; }
  .badge.gray  { background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; }
  .badge.info  { background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }

  .cand { border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; transition:border-color .15s, box-shadow .15s, transform .04s; cursor:pointer; }
  .cand:hover { border-color:#cbd5e1; box-shadow:0 6px 18px rgba(2,6,23,.06); }
  .cand.selected { border-color:#2563eb; box-shadow:0 8px 22px rgba(37,99,235,.12); }
  .cand-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .cand-title { font-weight:700; font-size:1.05rem; color:#0f172a; }
  .cand-sub { color:#475569; font-size:.93rem; }
  .cand-meta { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  .cand-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
  .btn.secondary { background:#f8fafc; color:#0f172a; border:1px solid #e2e8f0; }
  .btn.linky { background:transparent; border:none; color:#2563eb; padding:0; }
  .radio-wrap { display:flex; align-items:center; gap:8px; }

  .divider { height:1px; background:#e5e7eb; margin:14px 0; }
  .section-title { font-weight:800; color:#0f172a; margin:0 0 6px; }
  .subtle { color:#94a3b8; font-weight:600; font-size:.85rem; }
  .footer-actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

  /* Collapsible payload table */
  details > summary { list-style:none; cursor:pointer; user-select:none; padding:6px 0; outline:none; }
  details > summary::-webkit-details-marker { display:none; }
  .payload-wrap { border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; }
  .payload-table { width:100%; border-collapse:collapse; font-size:.9rem; }
  .payload-table th, .payload-table td { padding:8px 10px; border-top:1px solid #eef2f7; vertical-align:top; }
  .payload-table th { background:#f8fafc; color:#475569; text-align:left; width:36%; }
</style>

<div class="grid-2">

  <!-- LEFT: Client Provided -->
  <div class="card">
    <h3>Client Provided</h3>
    <div class="muted" style="margin-bottom:10px;">
      Input name: <strong>{{ item.input_name }}</strong>
      {% if item.search_url %}
        · <a href="{{ item.search_url }}" class="btn linky" target="_blank" rel="noopener">Open Search</a>
      {% endif %}
    </div>

    <!-- Headline K/Vs built in the view as client_info -->
    <table class="kvs">
      {% if client_info and client_info|length > 0 %}
        {% for row in client_info %}
          <tr>
            <td>{{ row.label }}</td>
            <td>{{ row.value }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td>—</td><td class="muted">No client metadata available</td></tr>
      {% endif %}
    </table>

    <!-- Collapsible: show ALL non-empty uploaded fields -->
    {% if schema_fields and schema_fields|length > 0 %}
      <details class="mt-3" style="margin-top:12px;">
        <summary class="subtle">Show all uploaded fields ({{ schema_fields|length }})</summary>
        <div class="payload-wrap" style="margin-top:8px; max-height: 18rem; overflow:auto;">
          <table class="payload-table">
            <thead>
              <tr><th>Field</th><th>Value</th></tr>
            </thead>
            <tbody>
              {% for f in schema_fields %}
                <tr><th>{{ f.header }}</th><td>{{ f.value }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    {% endif %}
  </div>

  <!-- RIGHT: Candidates + selection -->
  <div class="card">
    <h3>Review & Select Outcome</h3>
    <form method="post" action="/item/{{ item.id }}/confirm" id="decisionForm">
      <div class="subtle" style="margin-bottom:10px;">Select the best match below or choose <em>Unable to match</em>.</div>

      {% if candidates|length == 0 %}
        <p class="muted">No candidates were provided. You can choose “Unable to match”.</p>
      {% endif %}

      <div style="display:grid; gap:12px;">
        {% for c in candidates %}
          {% set cname       = c.get('candidate_entity_name') %}
          {% set cref        = c.get('ui_ref') %}
          {% set cref_label  = c.get('ui_ref_label') or 'Ref/No.' %}
          {% set cstat       = c.get('candidate_status') %}
          {% set caddr       = c.get('candidate_address') %}
          {% set cconf       = c.get('candidate_confidence') %}
          {% set curl        = c.get('ui_open_url') %}
          {% set reg_label   = c.get('ui_source_label') or 'Registry' %}
          {% set conf_badge  = 'green' if (cconf or 0) >= 0.8 else ('amber' if (cconf or 0) >= 0.5 else 'gray') %}
          {# selection value prefers CH number, else falls back to ui_ref (e.g., CC-123456) #}
          {% set sel_val     = c.get('candidate_company_number') or cref or '' %}

          <label class="cand" data-card>
            <div class="cand-head">
              <div>
                <div class="cand-title">
                  {{ cname or "Unknown entity" }}
                  <span class="badge info" style="margin-left:8px;">{{ reg_label }}</span>
                </div>
                <div class="cand-sub">
                  {% if cref %}
                    {{ cref_label }} <strong>{{ cref }}</strong>
                  {% else %}
                    {{ cref_label }} <strong>—</strong>
                  {% endif %}
                  {% if cstat %} · Status: <strong>{{ cstat }}</strong>{% endif %}
                </div>
              </div>
              <div class="cand-meta">
                <span class="badge {{ conf_badge }}">Confidence {{ (cconf * 100) | round(1) if cconf is not none else '—' }}%</span>

                {% if curl %}
                  <a class="btn secondary" href="{{ curl }}" target="_blank" rel="noopener">Open on {{ reg_label }}</a>
                {% endif %}

                <div class="radio-wrap">
                  <input type="radio" name="selection" value="{{ sel_val }}|{{ cname }}" />
                  <span class="muted">Select</span>
                </div>
              </div>
            </div>
            {% if caddr %}
              <div class="divider"></div>
              <div class="muted">{{ caddr }}</div>
            {% endif %}
          </label>
        {% endfor %}

        <!-- Unable to match -->
        <label class="cand" data-card>
          <div class="cand-head">
            <div class="cand-title">Unable to match</div>
            <div class="cand-meta">
              <span class="badge gray">No suitable candidates</span>
              <div class="radio-wrap">
                <input type="radio" name="selection" value="UNABLE|UNABLE">
                <span class="muted">Select</span>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="muted">Choose this if none of the candidates match the client-provided entity.</div>
        </label>
      </div>

      <div class="divider"></div>
      <div class="footer-actions">
        <a class="btn secondary" href="/queue/manual">Back to Manual Queue</a>
        <button class="btn primary" type="submit">Confirm Selection</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Make entire candidate cards toggle their radio and highlight
  document.querySelectorAll('[data-card]').forEach(card => {
    const radio = card.querySelector('input[type="radio"]');
    card.addEventListener('click', (e) => {
      if (e.target.tagName.toLowerCase() === 'a') return;
      if (e.target === radio) return;
      radio.checked = true;
      document.querySelectorAll('[data-card]').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
    });
    radio.addEventListener('change', () => {
      document.querySelectorAll('[data-card]').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
    });
  });
</script>
{% endblock %}